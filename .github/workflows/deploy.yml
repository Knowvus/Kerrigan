name: Deploy PostgreSQL

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy PostgreSQL to DigitalOcean Droplet
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DIGITALOCEAN_KERRIGAN_DROPLET_IP }}
          username: root
          password: ${{ secrets.KERRIGAN_ROOT_PASSWORD }}
          script: |
            set -x

            # Create a Docker network (if needed)
            docker network create app_network || true

            # Deploy PostgreSQL container
            docker run --name postgres-container --network app_network \
              -e POSTGRES_USER="${{ secrets.PG_USER }}" \
              -e POSTGRES_PASSWORD="${{ secrets.PG_PASSWORD }}" \
              -e POSTGRES_DB="${{ secrets.PG_DATABASE }}" \
              -p 5432:5432 -d postgres:latest

            # Verify that the PostgreSQL container is running
            sleep 5
            if [ $(docker ps -q -f name=postgres-container) ]; then
              echo "PostgreSQL container is running successfully."
              docker logs postgres-container
            else
              echo "PostgreSQL container failed to start. Here are the logs:"
              docker logs postgres-container
              echo "Container status:"
              docker inspect postgres-container
              exit 1
            fi
